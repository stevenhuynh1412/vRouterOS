# Hướng dẫn cấu hình CPU Affinity trong vRouterOS

## Giới thiệu

Trong **vRouterOS**, **CPU affinity** (gắn kết CPU) cho phép gán các tiến trình cụ thể (như tiến trình dataplane) cho một hoặc nhiều lõi CPU cụ thể. Điều này giúp tối ưu hóa hiệu suất bằng cách đảm bảo các tiến trình quan trọng được chạy trên các lõi CPU riêng biệt, giảm cạnh tranh tài nguyên và cải thiện hiệu quả xử lý mạng.

Tài liệu này hướng dẫn cách cấu hình CPU affinity cho tiến trình dataplane trong vRouterOS, bao gồm kiểm tra cấu hình hiện tại, đặt affinity, và xác minh thay đổi. Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về CPU Affinity

- **Mục đích**: Gắn một tiến trình (như `dataplane`) hoặc một luồng (thread) của tiến trình vào một tập hợp các lõi CPU cụ thể.
- **Lợi ích**:
  - Giảm cạnh tranh CPU giữa các tiến trình.
  - Tăng hiệu suất cho các tác vụ mạng quan trọng (như xử lý gói tin).
  - Đảm bảo phân bổ tài nguyên CPU ổn định trong các hệ thống đa lõi.
- **Tiến trình dataplane**: Trong vRouterOS, tiến trình `dataplane` chịu trách nhiệm xử lý gói tin mạng, là thành phần quan trọng cần được tối ưu hóa.

## Các lệnh cấu hình CPU Affinity

### 1. Kiểm tra CPU Affinity hiện tại
- **Mô tả**: Xem danh sách các tiến trình hoặc luồng dataplane và CPU nào chúng được gán.
- **Lệnh**:
  - Trong chế độ vận hành:
    ```
    $ show dataplane cpu-affinity
    ```
- **Ví dụ**:
  ```
  $ show dataplane cpu-affinity
  Thread ID  Thread Name        CPU Affinity
  ---------  -----------------  ------------
  12345      dataplane-main     0-3
  12346      dataplane-worker1  1
  12347      dataplane-worker2  2
  ```
  - Giải thích:
    - `Thread ID`: ID của luồng.
    - `Thread Name`: Tên luồng (ví dụ: `dataplane-main` là tiến trình chính).
    - `CPU Affinity`: Các lõi CPU mà luồng được gán (ví dụ: `0-3` nghĩa là lõi 0, 1, 2, 3).

### 2. Cấu hình CPU Affinity
- **Mô tả**: Gán một tiến trình hoặc luồng dataplane cho một hoặc nhiều lõi CPU cụ thể.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # set dataplane cpu-affinity <thread-name> <cpu-list>
    # commit
    # save
    ```
  - `<thread-name>`: Tên luồng (ví dụ: `dataplane-main`, `dataplane-worker1`).
  - `<cpu-list>`: Danh sách lõi CPU, có thể là một lõi (ví dụ: `1`), nhiều lõi riêng lẻ (ví dụ: `1,3`), hoặc khoảng lõi (ví dụ: `0-3`).
- **Ví dụ**:
  ```
  $ configure
  # set dataplane cpu-affinity dataplane-main 0-1
  # set dataplane cpu-affinity dataplane-worker1 2
  # set dataplane cpu-affinity dataplane-worker2 3
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  # exit
  ```
  - Giải thích:
    - Gán luồng `dataplane-main` cho lõi CPU 0 và 1.
    - Gán luồng `dataplane-worker1` cho lõi CPU 2.
    - Gán luồng `dataplane-worker2` cho lõi CPU 3.

### 3. Xóa cấu hình CPU Affinity
- **Mô tả**: Xóa cấu hình CPU affinity, trả về trạng thái mặc định (thường là tất cả các lõi CPU).
- **Lệnh**:
  ```
  # delete dataplane cpu-affinity <thread-name>
  # commit
  # save
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete dataplane cpu-affinity dataplane-worker1
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  # exit
  ```
  - Xóa cấu hình affinity cho `dataplane-worker1`, cho phép luồng này chạy trên tất cả các lõi CPU.

### 4. Kiểm tra cấu hình
- **Mô tả**: Xác minh cấu hình CPU affinity trong cấu hình làm việc hoặc đang chạy.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show dataplane cpu-affinity
    ```
  - Trong chế độ vận hành:
    ```
    $ show dataplane cpu-affinity
    ```
- **Ví dụ**:
  ```
  # show dataplane cpu-affinity
  cpu-affinity dataplane-main 0-1
  cpu-affinity dataplane-worker1 2
  cpu-affinity dataplane-worker2 3
  ```

### 5. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + dataplane cpu-affinity dataplane-main 0-1
    - dataplane cpu-affinity dataplane-worker1 1
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit, đưa cấu hình làm việc về trạng thái của cấu hình đang chạy.

## Ví dụ thực tế: Cấu hình CPU Affinity cho Dataplane
1. Kiểm tra CPU affinity hiện tại:
   ```
   $ show dataplane cpu-affinity
   Thread ID  Thread Name        CPU Affinity
   ---------  -----------------  ------------
   12345      dataplane-main     0-3
   12346      dataplane-worker1  0-3
   12347      dataplane-worker2  0-3
   ```
2. Vào chế độ cấu hình:
   ```
   $ configure
   ```
3. Gán CPU affinity:
   ```
   # set dataplane cpu-affinity dataplane-main 0-1
   # set dataplane cpu-affinity dataplane-worker1 2
   # set dataplane cpu-affinity dataplane-worker2 3
   ```
4. Kiểm tra cấu hình:
   ```
   # show dataplane cpu-affinity
   cpu-affinity dataplane-main 0-1
   cpu-affinity dataplane-worker1 2
   cpu-affinity dataplane-worker2 3
   ```
5. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
6. Xác minh trong chế độ vận hành:
   ```
   $ show dataplane cpu-affinity
   Thread ID  Thread Name        CPU Affinity
   ---------  -----------------  ------------
   12345      dataplane-main     0-1
   12346      dataplane-worker1  2
   12347      dataplane-worker2  3
   ```

## Lưu ý quan trọng
- **Tối ưu hóa hiệu suất**: Gán các luồng dataplane cho các lõi CPU riêng biệt để tránh cạnh tranh tài nguyên. Trên hệ thống đa lõi, nên phân bổ hợp lý dựa trên khối lượng công việc (workload).
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi:
  ```
  $ save /config/backup-YYYYMMDD.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi để xác định vấn đề (ví dụ: CPU lõi không hợp lệ).
- **Số lượng lõi CPU**: Kiểm tra số lõi CPU có sẵn:
  ```
  $ show hardware cpu
  ```
  - Hoặc dùng:
    ```
    cat /proc/cpuinfo
    ```
- **Tài liệu tham khảo**: Xem thêm chi tiết trên trang tài liệu vRouterOS hoặc các tài liệu liên quan tại https://docs.fwcloud.co

## Kết luận
Cấu hình CPU affinity trong vRouterOS giúp tối ưu hóa hiệu suất xử lý mạng bằng cách gán các tiến trình dataplane cho các lõi CPU cụ thể. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để quản lý hiệu quả. Thực hành các ví dụ trên để làm quen với quy trình cấu hình.