# Hướng dẫn cấu hình tường lửa trong vRouterOS

## Giới thiệu

Tường lửa (firewall) trong **vRouterOS** cho phép kiểm soát lưu lượng mạng bằng cách áp dụng các quy tắc (rules) để chấp nhận, từ chối, hoặc xử lý các gói tin dựa trên các tiêu chí như địa chỉ IP, giao thức, cổng, v.v. Tường lửa được cấu hình thông qua các **rule-set** (bộ quy tắc) được gắn vào các giao diện mạng trong các hướng cụ thể (input, output, forward).

Tài liệu này hướng dẫn cách:
- Tạo và quản lý rule-set tường lửa.
- Áp dụng rule-set vào giao diện.
- Kiểm tra và giám sát trạng thái tường lửa.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về tường lửa

- **Rule-set**: Một bộ quy tắc xác định cách xử lý lưu lượng mạng. Mỗi rule-set chứa các quy tắc được đánh số (rule number) và được xử lý theo thứ tự.
- **Hành động (Action)**: Mỗi quy tắc có thể:
  - `accept`: Cho phép gói tin.
  - `drop`: Từ chối gói tin.
  - `reject`: Từ chối gói tin và gửi thông báo (như ICMP).
- **Hướng giao diện**:
  - `in`: Lưu lượng vào giao diện.
  - `out`: Lưu lượng ra từ giao diện.
  - `local`: Lưu lượng đến chính hệ thống (vRouterOS).
- **Tiêu chí khớp (Match criteria)**: Bao gồm địa chỉ IP nguồn/đích, giao thức (TCP, UDP, ICMP), cổng, v.v.

## Các lệnh cấu hình tường lửa

### 1. Tạo Rule-set tường lửa
- **Mô tả**: Tạo một bộ quy tắc tường lửa với tên cụ thể.
- **Lệnh**:
  ```
  # set firewall name <rule-set-name> rule <rule-number> <attribute> <value>
  ```
  - `<rule-set-name>`: Tên của rule-set (ví dụ: `WAN_IN`).
  - `<rule-number>`: Số thứ tự quy tắc (1, 2, 3,...).
  - `<attribute>`: Thuộc tính quy tắc (như `action`, `source`, `destination`, `protocol`).
  - `<value>`: Giá trị cụ thể (như `accept`, `192.0.2.0/24`, `tcp`).
- **Ví dụ**:
  ```
  $ configure
  # set firewall name WAN_IN rule 10 action accept
  # set firewall name WAN_IN rule 10 source address 192.0.2.0/24
  # set firewall name WAN_IN rule 10 destination port 80
  # set firewall name WAN_IN rule 10 protocol tcp
  # commit
  ```
  - Tạo rule-set `WAN_IN` với quy tắc số 10, cho phép lưu lượng TCP từ mạng `192.0.2.0/24` đến cổng 80.

### 2. Áp dụng Rule-set vào giao diện
- **Mô tả**: Gắn rule-set vào giao diện với hướng cụ thể (`in`, `out`, `local`).
- **Lệnh**:
  ```
  # set interfaces dataplane <interface> firewall <direction> <rule-set-name>
  ```
  - `<interface>`: Tên giao diện (ví dụ: `dp0s3`).
  - `<direction>`: Hướng (`in`, `out`, `local`).
- **Ví dụ**:
  ```
  # set interfaces dataplane dp0s3 firewall in WAN_IN
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Áp dụng rule-set `WAN_IN` cho lưu lượng vào (`in`) trên giao diện `dp0s3`.

### 3. Xóa Rule-set hoặc quy tắc
- **Mô tả**: Xóa một quy tắc cụ thể hoặc toàn bộ rule-set.
- **Lệnh**:
  ```
  # delete firewall name <rule-set-name> rule <rule-number>
  # delete firewall name <rule-set-name>
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete firewall name WAN_IN rule 10
  # commit
  # save
  ```
  - Xóa quy tắc số 10 trong rule-set `WAN_IN`.
  ```
  # delete firewall name WAN_IN
  # commit
  # save
  ```
  - Xóa toàn bộ rule-set `WAN_IN`.

### 4. Kiểm tra cấu hình tường lửa
- **Mô tả**: Xem cấu hình tường lửa hiện tại.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show firewall
    ```
  - Trong chế độ vận hành:
    ```
    $ show firewall
    $ show firewall name <rule-set-name>
    ```
- **Ví dụ**:
  ```
  # show firewall
  name WAN_IN {
      rule 10 {
          action accept
          source {
              address 192.0.2.0/24
          }
          destination {
              port 80
          }
          protocol tcp
      }
  }
  ```

### 5. Kiểm tra trạng thái tường lửa
- **Mô tả**: Hiển thị thống kê và trạng thái hoạt động của tường lửa (số gói tin khớp với quy tắc).
- **Lệnh**:
  ```
  $ show firewall name <rule-set-name> statistics
  ```
- **Ví dụ**:
  ```
  $ show firewall name WAN_IN statistics
  Rule    Packets    Bytes    Action    Source         Destination
  ----    -------    -----    ------    ------         -----------
  10      1500       120000   ACCEPT    192.0.2.0/24   port 80
  ```
  - Hiển thị số gói tin và byte khớp với quy tắc 10 trong rule-set `WAN_IN`.

### 6. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + firewall name WAN_IN rule 10 action accept
    + firewall name WAN_IN rule 10 source address 192.0.2.0/24
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit, đưa cấu hình làm việc về trạng thái của cấu hình đang chạy.

## Ví dụ thực tế: Cấu hình tường lửa cho giao diện
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Tạo rule-set `WAN_IN`:
   ```
   # set firewall name WAN_IN rule 10 action accept
   # set firewall name WAN_IN rule 10 source address 192.0.2.0/24
   # set firewall name WAN_IN rule 10 destination port 80
   # set firewall name WAN_IN rule 10 protocol tcp
   # set firewall name WAN_IN rule 20 action drop
   # set firewall name WAN_IN rule 20 protocol all
   ```
   - Quy tắc 10: Cho phép lưu lượng TCP từ `192.0.2.0/24` đến cổng 80.
   - Quy tắc 20: Từ chối tất cả lưu lượng khác.
3. Áp dụng rule-set vào giao diện:
   ```
   # set interfaces dataplane dp0s3 firewall in WAN_IN
   ```
4. Kiểm tra cấu hình:
   ```
   # show firewall
   name WAN_IN {
       rule 10 {
           action accept
           source {
               address 192.0.2.0/24
           }
           destination {
               port 80
           }
           protocol tcp
       }
       rule 20 {
           action drop
           protocol all
       }
   }
   ```
5. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
6. Kiểm tra trạng thái trong chế độ vận hành:
   ```
   $ show firewall name WAN_IN statistics
   Rule    Packets    Bytes    Action    Source         Destination
   ----    -------    -----    ------    ------         -----------
   10      1500       120000   ACCEPT    192.0.2.0/24   port 80
   20      500        40000    DROP      any            any
   ```

## Lưu ý quan trọng
- **Thứ tự quy tắc**: Các quy tắc trong rule-set được xử lý theo số thứ tự (`rule-number`). Quy tắc có số nhỏ hơn được ưu tiên.
- **Hành động mặc định**: Nếu không có quy tắc nào khớp, lưu lượng sẽ bị từ chối trừ khi có quy tắc `default-action` được đặt (ví dụ: `set firewall name WAN_IN default-action accept`).
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi tường lửa:
  ```
  $ save /config/backup-20250907.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi để sửa cấu hình (ví dụ: địa chỉ IP không hợp lệ).
- **Giám sát hiệu suất**: Sử dụng `show firewall name <rule-set-name> statistics` để theo dõi lưu lượng khớp với quy tắc.
- **Tài liệu tham khảo**: Xem thêm chi tiết trên trang tài liệu vRouterOS hoặc tại https://docs.fwcloud.co

## Kết luận
Cấu hình tường lửa trong vRouterOS cho phép kiểm soát lưu lượng mạng một cách linh hoạt thông qua các rule-set và quy tắc. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để quản lý hiệu quả. Thực hành các ví dụ trên để làm quen với quy trình cấu hình tường lửa.