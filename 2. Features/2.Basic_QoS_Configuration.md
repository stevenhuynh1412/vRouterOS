# Hướng dẫn cấu hình QoS cơ bản trong vRouterOS

## Giới thiệu

**Chất lượng Dịch vụ (QoS)** trong **vRouterOS** cho phép quản lý và kiểm soát lưu lượng mạng để đảm bảo hiệu suất tối ưu cho các ứng dụng hoặc dịch vụ cụ thể. QoS được sử dụng để ưu tiên lưu lượng, giới hạn băng thông, hoặc kiểm soát tắc nghẽn trên các giao diện mạng. Trong vRouterOS, QoS được triển khai thông qua các **chính sách QoS** (QoS policies) được áp dụng cho các giao diện trong các hướng cụ thể (input hoặc output).

Tài liệu này hướng dẫn cách:
- Tạo chính sách QoS với các quy tắc để phân loại và xử lý lưu lượng.
- Áp dụng chính sách QoS vào giao diện.
- Kiểm tra và giám sát trạng thái QoS.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về QoS

- **Chính sách QoS (QoS Policy)**: Một tập hợp các quy tắc (rules) xác định cách phân loại và xử lý lưu lượng. Mỗi chính sách chứa các quy tắc được đánh số (rule number) và được xử lý theo thứ tự.
- **Phân loại lưu lượng**: Dựa trên các tiêu chí như địa chỉ IP nguồn/đích, giao thức (TCP, UDP, ICMP), cổng, hoặc DSCP (Differentiated Services Code Point).
- **Hành động QoS**:
  - `bandwidth`: Giới hạn hoặc đảm bảo băng thông cho lưu lượng.
  - `priority`: Đặt mức độ ưu tiên cho lưu lượng (ví dụ: cao, trung bình, thấp).
  - `queue-type`: Loại hàng đợi (ví dụ: `fair-queue`, `drop-tail`).
- **Hướng giao diện**:
  - `out`: Áp dụng QoS cho lưu lượng ra từ giao diện.
  - `in`: Áp dụng QoS cho lưu lượng vào giao diện (ít phổ biến hơn).

## Các lệnh cấu hình QoS

### 1. Tạo chính sách QoS
- **Mô tả**: Tạo một chính sách QoS với tên cụ thể và các quy tắc để phân loại và xử lý lưu lượng.
- **Lệnh**:
  ```
  # set qos policy <policy-name> rule <rule-number> <attribute> <value>
  ```
  - `<policy-name>`: Tên của chính sách QoS (ví dụ: `LIMIT_BANDWIDTH`).
  - `<rule-number>`: Số thứ tự quy tắc (1, 2, 3,...).
  - `<attribute>`: Thuộc tính quy tắc (như `match`, `bandwidth`, `priority`, `queue-type`, `source`, `destination`, `protocol`).
  - `<value>`: Giá trị cụ thể (ví dụ: `10mbit`, `high`, `tcp`).
- **Ví dụ**:
  ```
  $ configure
  # set qos policy LIMIT_BANDWIDTH rule 10 match VOIP
  # set qos policy LIMIT_BANDWIDTH rule 10 protocol udp
  # set qos policy LIMIT_BANDWIDTH rule 10 destination port 5060
  # set qos policy LIMIT_BANDWIDTH rule 10 bandwidth 2mbit
  # set qos policy LIMIT_BANDWIDTH rule 10 priority high
  # set qos policy LIMIT_BANDWIDTH rule 20 match ALL
  # set qos policy LIMIT_BANDWIDTH rule 20 bandwidth 8mbit
  # commit
  ```
  - Tạo chính sách `LIMIT_BANDWIDTH`:
    - Quy tắc 10: Giới hạn lưu lượng UDP (VOIP) đến cổng 5060 ở 2 Mbit/s với ưu tiên cao.
    - Quy tắc 20: Giới hạn tất cả lưu lượng còn lại ở 8 Mbit/s.

### 2. Áp dụng chính sách QoS vào giao diện
- **Mô tả**: Gắn chính sách QoS vào giao diện với hướng cụ thể (`out` hoặc `in`).
- **Lệnh**:
  ```
  # set interfaces dataplane <interface> qos <policy-name>
  ```
  - `<interface>`: Tên giao diện (ví dụ: `dp0s3`).
  - `<policy-name>`: Tên chính sách QoS.
- **Ví dụ**:
  ```
  # set interfaces dataplane dp0s3 qos LIMIT_BANDWIDTH
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Áp dụng chính sách `LIMIT_BANDWIDTH` cho lưu lượng ra trên giao diện `dp0s3`.

### 3. Xóa chính sách QoS hoặc quy tắc
- **Mô tả**: Xóa một quy tắc cụ thể hoặc toàn bộ chính sách QoS.
- **Lệnh**:
  ```
  # delete qos policy <policy-name> rule <rule-number>
  # delete qos policy <policy-name>
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete qos policy LIMIT_BANDWIDTH rule 10
  # commit
  # save
  ```
  - Xóa quy tắc số 10 trong chính sách `LIMIT_BANDWIDTH`.
  ```
  # delete qos policy LIMIT_BANDWIDTH
  # commit
  # save
  ```
  - Xóa toàn bộ chính sách `LIMIT_BANDWIDTH`.

### 4. Kiểm tra cấu hình QoS
- **Mô tả**: Xem cấu hình QoS hiện tại.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show qos
    ```
  - Trong chế độ vận hành:
    ```
    $ show qos
    $ show qos policy <policy-name>
    ```
- **Ví dụ**:
  ```
  # show qos
  policy LIMIT_BANDWIDTH {
      rule 10 {
          match VOIP
          protocol udp
          destination {
              port 5060
          }
          bandwidth 2mbit
          priority high
      }
      rule 20 {
          match ALL
          bandwidth 8mbit
      }
  }
  ```

### 5. Kiểm tra trạng thái QoS
- **Mô tả**: Hiển thị thống kê QoS, bao gồm số gói tin và byte khớp với các quy tắc.
- **Lệnh**:
  ```
  $ show qos policy <policy-name> statistics
  ```
- **Ví dụ**:
  ```
  $ show qos policy LIMIT_BANDWIDTH statistics
  Rule    Packets    Bytes    Match     Protocol    Destination
  ----    -------    -----    ------    --------    -----------
  10      2000       160000   VOIP      udp         port 5060
  20      5000       400000   ALL       any         any
  ```
  - Hiển thị số gói tin và byte khớp với các quy tắc trong chính sách `LIMIT_BANDWIDTH`.

### 6. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + qos policy LIMIT_BANDWIDTH rule 10 match VOIP
    + qos policy LIMIT_BANDWIDTH rule 10 protocol udp
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit, đưa cấu hình làm việc về trạng thái của cấu hình đang chạy.

## Ví dụ thực tế: Cấu hình QoS cho giao diện
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Tạo chính sách QoS `LIMIT_BANDWIDTH`:
   ```
   # set qos policy LIMIT_BANDWIDTH rule 10 match VOIP
   # set qos policy LIMIT_BANDWIDTH rule 10 protocol udp
   # set qos policy LIMIT_BANDWIDTH rule 10 destination port 5060
   # set qos policy LIMIT_BANDWIDTH rule 10 bandwidth 2mbit
   # set qos policy LIMIT_BANDWIDTH rule 10 priority high
   # set qos policy LIMIT_BANDWIDTH rule 20 match ALL
   # set qos policy LIMIT_BANDWIDTH rule 20 bandwidth 8mbit
   ```
   - Quy tắc 10: Ưu tiên cao và giới hạn 2 Mbit/s cho lưu lượng VOIP (UDP, cổng 5060).
   - Quy tắc 20: Giới hạn 8 Mbit/s cho tất cả lưu lượng còn lại.
3. Áp dụng chính sách vào giao diện:
   ```
   # set interfaces dataplane dp0s3 qos LIMIT_BANDWIDTH
   ```
4. Kiểm tra cấu hình:
   ```
   # show qos
   policy LIMIT_BANDWIDTH {
       rule 10 {
           match VOIP
           protocol udp
           destination {
               port 5060
           }
           bandwidth 2mbit
           priority high
       }
       rule 20 {
           match ALL
           bandwidth 8mbit
       }
   }
   ```
5. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
6. Kiểm tra trạng thái trong chế độ vận hành:
   ```
   $ show qos policy LIMIT_BANDWIDTH statistics
   Rule    Packets    Bytes    Match     Protocol    Destination
   ----    -------    -----    ------    --------    -----------
   10      2000       160000   VOIP      udp         port 5060
   20      5000       400000   ALL       any         any
   ```

## Lưu ý quan trọng
- **Thứ tự quy tắc**: Các quy tắc trong chính sách QoS được xử lý theo số thứ tự (`rule-number`). Quy tắc có số nhỏ hơn được ưu tiên.
- **Hành động mặc định**: Nếu không có quy tắc nào khớp, lưu lượng sẽ không bị giới hạn trừ khi có quy tắc `default-action` hoặc `default-bandwidth`.
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi QoS:
  ```
  $ save /config/backup-20250907.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi để sửa cấu hình (ví dụ: băng thông không hợp lệ).
- **Giám sát hiệu suất**: Sử dụng `show qos policy <policy-name> statistics` để theo dõi lưu lượng khớp với quy tắc.
- **Tài liệu tham khảo**: Xem thêm chi tiết trên trang tài liệu vRouterOS hoặc tại https://docs.fwcloud.co

## Kết luận
Cấu hình QoS trong vRouterOS cho phép quản lý băng thông và ưu tiên lưu lượng mạng một cách linh hoạt thông qua các chính sách và quy tắc. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để quản lý hiệu quả. Thực hành các ví dụ trên để làm quen với quy trình cấu hình QoS.