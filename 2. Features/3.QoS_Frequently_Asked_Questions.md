# Câu hỏi thường gặp về QoS trong vRouterOS

## Giới thiệu

Tài liệu này trả lời các câu hỏi thường gặp (FAQ) về **Chất lượng Dịch vụ (QoS)** trong **vRouterOS**, giúp người dùng hiểu cách cấu hình, áp dụng, và giám sát QoS để quản lý lưu lượng mạng. Các câu hỏi bao gồm các khía cạnh như cách QoS hoạt động, cách áp dụng chính sách, và cách xử lý lỗi. Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** và **lưu** để duy trì sau khi khởi động lại.

## Câu hỏi thường gặp

### 1. QoS trong vRouterOS hoạt động như thế nào?
- **Trả lời**: QoS trong vRouterOS cho phép kiểm soát lưu lượng mạng bằng cách phân loại và xử lý các gói tin dựa trên các tiêu chí như địa chỉ IP, giao thức, cổng, hoặc DSCP. Các chính sách QoS (QoS policies) được định nghĩa với các quy tắc (rules) để:
  - Giới hạn băng thông (`bandwidth`).
  - Đặt mức độ ưu tiên (`priority`).
  - Sử dụng các loại hàng đợi (`queue-type`, ví dụ: `fair-queue`, `drop-tail`).
- Các chính sách được áp dụng cho giao diện trong hướng `in` hoặc `out`. Quy tắc được xử lý theo thứ tự số thứ tự (`rule-number`), và lưu lượng không khớp sẽ tuân theo hành động mặc định (nếu được cấu hình).
- **Ví dụ**:
  ```
  $ configure
  # set qos policy VOIP_PRIORITY rule 10 match VOIP
  # set qos policy VOIP_PRIORITY rule 10 protocol udp
  # set qos policy VOIP_PRIORITY rule 10 destination port 5060
  # set qos policy VOIP_PRIORITY rule 10 priority high
  # set interfaces dataplane dp0s3 qos VOIP_PRIORITY
  # commit
  # save
  ```
  - Ưu tiên cao cho lưu lượng VOIP (UDP, cổng 5060) trên giao diện `dp0s3`.

### 2. Tôi có thể áp dụng QoS cho hướng nào của giao diện?
- **Trả lời**: Trong vRouterOS, QoS thường được áp dụng cho:
  - **Hướng `out`**: Lưu lượng ra khỏi giao diện (phổ biến nhất, dùng để kiểm soát băng thông gửi đi).
  - **Hướng `in`**: Lưu lượng vào giao diện (ít phổ biến, thường dùng cho các trường hợp đặc biệt).
- **Lệnh**:
  ```
  # set interfaces dataplane <interface> qos <policy-name>
  ```
- **Ví dụ**:
  ```
  # set interfaces dataplane dp0s3 qos LIMIT_BANDWIDTH
  ```
  - Áp dụng chính sách `LIMIT_BANDWIDTH` cho lưu lượng ra (`out`) trên `dp0s3`.

### 3. Làm thế nào để kiểm tra xem QoS có hoạt động đúng không?
- **Trả lời**: Sử dụng lệnh `show qos` để kiểm tra cấu hình và thống kê QoS:
  - Xem cấu hình:
    ```
    $ show qos
    $ show qos policy <policy-name>
    ```
  - Xem thống kê:
    ```
    $ show qos policy <policy-name> statistics
    ```
- **Ví dụ**:
  ```
  $ show qos policy VOIP_PRIORITY statistics
  Rule    Packets    Bytes    Match     Protocol    Destination
  ----    -------    -----    ------    --------    -----------
  10      2000       160000   VOIP      udp         port 5060
  ```
  - Cho biết số gói tin và byte khớp với quy tắc 10.

### 4. Điều gì xảy ra nếu không có quy tắc nào khớp với lưu lượng?
- **Trả lời**: Nếu không có quy tắc nào trong chính sách QoS khớp với lưu lượng, hành động mặc định sẽ được áp dụng. Mặc định, lưu lượng không bị giới hạn trừ khi bạn cấu hình `default-action` hoặc `default-bandwidth` trong chính sách.
- **Ví dụ**:
  ```
  # set qos policy LIMIT_BANDWIDTH default-action drop
  # set qos policy LIMIT_BANDWIDTH default-bandwidth 1mbit
  ```
  - Từ chối hoặc giới hạn lưu lượng không khớp ở 1 Mbit/s.

### 5. Tôi có thể cấu hình nhiều chính sách QoS cho cùng một giao diện không?
- **Trả lời**: Không, trong vRouterOS, mỗi giao diện chỉ có thể áp dụng **một chính sách QoS** cho mỗi hướng (`in` hoặc `out`). Nếu cần xử lý nhiều loại lưu lượng, bạn phải tạo một chính sách với nhiều quy tắc.
- **Ví dụ**:
  ```
  # set qos policy MIXED_TRAFFIC rule 10 match VOIP
  # set qos policy MIXED_TRAFFIC rule 10 protocol udp
  # set qos policy MIXED_TRAFFIC rule 10 destination port 5060
  # set qos policy MIXED_TRAFFIC rule 10 bandwidth 2mbit
  # set qos policy MIXED_TRAFFIC rule 20 match HTTP
  # set qos policy MIXED_TRAFFIC rule 20 protocol tcp
  # set qos policy MIXED_TRAFFIC rule 20 destination port 80
  # set qos policy MIXED_TRAFFIC rule 20 bandwidth 5mbit
  # set interfaces dataplane dp0s3 qos MIXED_TRAFFIC
  # commit
  ```

### 6. Làm thế nào để xóa một chính sách QoS?
- **Trả lời**: Xóa chính sách QoS hoặc quy tắc cụ thể bằng lệnh `delete`.
- **Lệnh**:
  ```
  # delete qos policy <policy-name> rule <rule-number>
  # delete qos policy <policy-name>
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete qos policy VOIP_PRIORITY rule 10
  # commit
  # save
  ```
  - Xóa quy tắc 10.
  ```
  # delete qos policy VOIP_PRIORITY
  # commit
  # save
  ```
  - Xóa toàn bộ chính sách `VOIP_PRIORITY`.

### 7. Các loại hàng đợi nào được hỗ trợ?
- **Trả lời**: vRouterOS hỗ trợ các loại hàng đợi sau:
  - `drop-tail`: Hàng đợi đơn giản, bỏ gói tin khi đầy (thích hợp cho lưu lượng thông thường).
  - `fair-queue`: Phân chia băng thông công bằng giữa các luồng lưu lượng.
  - `priority-queue`: Ưu tiên lưu lượng dựa trên mức độ ưu tiên (`high`, `medium`, `low`).
- **Ví dụ**:
  ```
  # set qos policy VOIP_PRIORITY rule 10 queue-type priority-queue
  # set qos policy VOIP_PRIORITY rule 10 priority high
  ```

### 8. Làm thế nào để xử lý lỗi khi commit QoS?
- **Trả lời**: Nếu lệnh `commit` thất bại, thông báo lỗi sẽ hiển thị nguyên nhân (ví dụ: băng thông không hợp lệ, giao diện không tồn tại). Các bước xử lý:
  - Kiểm tra thông báo lỗi:
    ```
    # commit
    [qos policy LIMIT_BANDWIDTH rule 10 bandwidth 0mbit]
    Invalid bandwidth value
    ```
  - Sửa cấu hình:
    ```
    # set qos policy LIMIT_BANDWIDTH rule 10 bandwidth 1mbit
    # commit
    ```
  - Kiểm tra cấu hình:
    ```
    # show qos
    ```
  - Nếu cần, hủy bỏ thay đổi:
    ```
    # discard
    ```

### 9. Tôi có thể giám sát hiệu suất QoS như thế nào?
- **Trả lời**: Sử dụng lệnh `show qos policy <policy-name> statistics` để xem số liệu thống kê về lưu lượng khớp với các quy tắc. Ngoài ra, kiểm tra tải hệ thống:
  ```
  $ show system cpu
  $ show system memory
  ```
- **Ví dụ**:
  ```
  $ show qos policy LIMIT_BANDWIDTH statistics
  Rule    Packets    Bytes    Match     Protocol    Destination
  ----    -------    -----    ------    --------    -----------
  10      2000       160000   VOIP      udp         port 5060
  20      5000       400000   ALL       any         any
  ```

## Ví dụ thực tế: Cấu hình QoS ưu tiên VOIP
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Tạo chính sách QoS:
   ```
   # set qos policy VOIP_PRIORITY rule 10 match VOIP
   # set qos policy VOIP_PRIORITY rule 10 protocol udp
   # set qos policy VOIP_PRIORITY rule 10 destination port 5060
   # set qos policy VOIP_PRIORITY rule 10 bandwidth 2mbit
   # set qos policy VOIP_PRIORITY rule 10 priority high
   # set qos policy VOIP_PRIORITY rule 20 match ALL
   # set qos policy VOIP_PRIORITY rule 20 bandwidth 8mbit
   ```
3. Áp dụng chính sách:
   ```
   # set interfaces dataplane dp0s3 qos VOIP_PRIORITY
   ```
4. Kiểm tra cấu hình:
   ```
   # show qos
   policy VOIP_PRIORITY {
       rule 10 {
           match VOIP
           protocol udp
           destination {
               port 5060
           }
           bandwidth 2mbit
           priority high
       }
       rule 20 {
           match ALL
           bandwidth 8mbit
       }
   }
   ```
5. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
6. Kiểm tra trạng thái:
   ```
   $ show qos policy VOIP_PRIORITY statistics
   Rule    Packets    Bytes    Match     Protocol    Destination
   ----    -------    -----    ------    --------    -----------
   10      2000       160000   VOIP      udp         port 5060
   20      5000       400000   ALL       any         any
   ```

## Lưu ý quan trọng
- **Thứ tự quy tắc**: Quy tắc được xử lý theo số thứ tự (`rule-number`). Đặt quy tắc ưu tiên cao (như VOIP) ở số nhỏ hơn.
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi QoS:
  ```
  $ save /config/backup-20250907.conf
  ```
- **Kiểm tra lỗi**: Đọc thông báo lỗi khi `commit` thất bại để sửa cấu hình.
- **Hiệu suất hệ thống**: QoS có thể tăng tải CPU. Theo dõi bằng `show system cpu`.
- **Tài liệu tham khảo**: Xem thêm chi tiết trên trang tài liệu vRouterOS hoặc tại https://docs.fwcloud.co

## Kết luận
Các câu hỏi thường gặp này cung cấp cái nhìn tổng quan về cách cấu hình và quản lý QoS trong vRouterOS. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để triển khai và giám sát QoS hiệu quả. Thực hành các ví dụ để làm quen với quy trình.