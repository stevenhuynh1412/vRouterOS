# Hướng dẫn xử lý sự cố QoS trong vRouterOS

## Giới thiệu

Tài liệu này cung cấp hướng dẫn về cách xử lý các sự cố liên quan đến **Chất lượng Dịch vụ (QoS)** trong **vRouterOS**. QoS được sử dụng để quản lý băng thông, ưu tiên lưu lượng, và kiểm soát tắc nghẽn mạng, nhưng có thể gặp các vấn đề như cấu hình sai, chính sách không hoạt động, hoặc hiệu suất không như mong đợi. Tài liệu này mô tả các vấn đề phổ biến, cách kiểm tra, và các bước khắc phục.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Đảm bảo **commit** các thay đổi và **lưu** để duy trì sau khi khởi động lại.

## Các vấn đề phổ biến và cách khắc phục

### 1. Chính sách QoS không hoạt động như mong đợi
- **Triệu chứng**: Lưu lượng không được ưu tiên hoặc giới hạn đúng cách (ví dụ: lưu lượng VOIP không được ưu tiên, băng thông không bị giới hạn).
- **Nguyên nhân có thể**:
  - Chính sách không được áp dụng cho giao diện.
  - Quy tắc QoS sai hoặc không khớp với lưu lượng.
  - Thứ tự quy tắc không đúng (quy tắc có số lớn hơn được xử lý sau).
- **Cách kiểm tra**:
  - Xác minh chính sách được áp dụng:
    ```
    $ show qos
    ```
    - Đảm bảo chính sách được gắn vào giao diện (ví dụ: `dp0s3`).
  - Kiểm tra thống kê QoS:
    ```
    $ show qos policy <policy-name> statistics
    ```
    - Nếu không có gói tin khớp (packets/bytes = 0), quy tắc có thể không khớp với lưu lượng.
  - Xem cấu hình chi tiết:
    ```
    $ show configuration commands | match qos
    ```
- **Khắc phục**:
  - Kiểm tra giao diện:
    ```
    # show interfaces dataplane dp0s3 qos
    qos LIMIT_BANDWIDTH
    ```
    - Nếu không thấy chính sách, áp dụng lại:
      ```
      $ configure
      # set interfaces dataplane dp0s3 qos LIMIT_BANDWIDTH
      # commit
      # save
      ```
  - Sửa quy tắc:
    - Kiểm tra tiêu chí khớp (match criteria) như địa chỉ IP, giao thức, cổng:
      ```
      # show qos policy LIMIT_BANDWIDTH
      policy LIMIT_BANDWIDTH {
          rule 10 {
              match VOIP
              protocol udp
              destination {
                  port 5060
              }
              bandwidth 2mbit
          }
      }
      ```
    - Nếu sai, sửa lại (ví dụ: cổng 5060 thay vì 5061):
      ```
      # set qos policy LIMIT_BANDWIDTH rule 10 destination port 5060
      # commit
      # save
      ```
  - Sắp xếp lại thứ tự quy tắc:
    - Đặt quy tắc ưu tiên cao (như VOIP) ở số nhỏ hơn:
      ```
      # delete qos policy LIMIT_BANDWIDTH rule 10
      # set qos policy LIMIT_BANDWIDTH rule 5 match VOIP
      # set qos policy LIMIT_BANDWIDTH rule 5 protocol udp
      # set qos policy LIMIT_BANDWIDTH rule 5 destination port 5060
      # set qos policy LIMIT_BANDWIDTH rule 5 bandwidth 2mbit
      # commit
      ```

### 2. Lệnh `commit` thất bại với lỗi QoS
- **Triệu chứng**: Lệnh `commit` báo lỗi, ví dụ: "Invalid bandwidth value" hoặc "Queue type not supported".
- **Nguyên nhân có thể**:
  - Giá trị băng thông không hợp lệ (ví dụ: `0mbit` hoặc định dạng sai).
  - Loại hàng đợi không được hỗ trợ.
  - Giao diện không tồn tại hoặc không hỗ trợ QoS.
- **Cách kiểm tra**:
  - Đọc thông báo lỗi:
    ```
    # commit
    [qos policy LIMIT_BANDWIDTH rule 10 bandwidth 0mbit]
    Invalid bandwidth value
    ```
  - Kiểm tra cấu hình:
    ```
    # show qos policy LIMIT_BANDWIDTH
    ```
- **Khắc phục**:
  - Sửa giá trị băng thông:
    ```
    # set qos policy LIMIT_BANDWIDTH rule 10 bandwidth 1mbit
    # commit
    ```
  - Đảm bảo loại hàng đợi hợp lệ (`drop-tail`, `fair-queue`, `priority-queue`):
    ```
    # set qos policy LIMIT_BANDWIDTH rule 10 queue-type fair-queue
    # commit
    ```
  - Kiểm tra giao diện tồn tại:
    ```
    $ show interfaces
    ```
    - Nếu giao diện `dp0s3` không tồn tại, sửa lại:
      ```
      # delete interfaces dataplane dp0s3 qos
      # set interfaces dataplane dp0s4 qos LIMIT_BANDWIDTH