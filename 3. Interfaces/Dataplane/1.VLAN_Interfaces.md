# Hướng dẫn cấu hình giao diện VLAN trong vRouterOS

## Giới thiệu

**VLAN (Virtual Local Area Network)** trong **vRouterOS** cho phép phân chia một giao diện vật lý thành nhiều giao diện ảo, mỗi giao diện được gán một VLAN ID để xử lý lưu lượng thuộc các VLAN khác nhau. Điều này hữu ích cho việc tách biệt lưu lượng mạng, tăng cường bảo mật, và quản lý hiệu quả các mạng con.

Tài liệu này hướng dẫn cách:
- Tạo và cấu hình giao diện VLAN trên giao diện dataplane.
- Gán địa chỉ IP, áp dụng chính sách QoS hoặc tường lửa cho VLAN.
- Kiểm tra và giám sát trạng thái giao diện VLAN.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về giao diện VLAN

- **Giao diện VLAN**: Một giao diện ảo được tạo trên một giao diện vật lý (như `dp0s3`), được gắn với một VLAN ID (1-4094) để xử lý lưu lượng của VLAN đó.
- **Tên giao diện VLAN**: Trong vRouterOS, giao diện VLAN có định dạng `<interface>.<vlan-id>` (ví dụ: `dp0s3.100` cho VLAN 100 trên giao diện `dp0s3`).
- **Ứng dụng**:
  - Tách biệt lưu lượng giữa các phòng ban hoặc khách hàng.
  - Áp dụng chính sách QoS, tường lửa, hoặc DPI riêng cho từng VLAN.
  - Hỗ trợ các cấu hình mạng phức tạp như trunking hoặc inter-VLAN routing.

## Các lệnh cấu hình giao diện VLAN

### 1. Tạo giao diện VLAN
- **Mô tả**: Tạo một giao diện VLAN trên một giao diện dataplane với VLAN ID cụ thể.
- **Lệnh**:
  ```
  # set interfaces dataplane <interface> vif <vlan-id>
  ```
  - `<interface>`: Tên giao diện vật lý (ví dụ: `dp0s3`).
  - `<vlan-id>`: ID của VLAN (1-4094).
- **Ví dụ**:
  ```
  $ configure
  # set interfaces dataplane dp0s3 vif 100
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Tạo giao diện VLAN `dp0s3.100` cho VLAN 100.

### 2. Gán địa chỉ IP cho giao diện VLAN
- **Mô tả**: Cấu hình địa chỉ IP cho giao diện VLAN để hỗ trợ định tuyến hoặc dịch vụ mạng.
- **Lệnh**:
  ```
  # set interfaces dataplane <interface> vif <vlan-id> address <ip-address/prefix>
  ```
- **Ví dụ**:
  ```
  # set interfaces dataplane dp0s3 vif 100 address 192.168.100.1/24
  # commit
  # save
  ```
  - Gán địa chỉ IP `192.168.100.1/24` cho giao diện `dp0s3.100`.

### 3. Áp dụng chính sách QoS hoặc tường lửa cho giao diện VLAN
- **Mô tả**: Áp dụng chính sách QoS, tường lửa, hoặc DPI cho giao diện VLAN để kiểm soát lưu lượng.
- **Lệnh**:
  ```
  # set interfaces dataplane <interface> vif <vlan-id> qos <policy-name>
  # set interfaces dataplane <interface> vif <vlan-id> firewall <direction> <rule-set-name>
  # set interfaces dataplane <interface> vif <vlan-id> dpi policy <policy-name>
  ```
  - `<direction>`: Hướng tường lửa (`in`, `out`, `local`).
- **Ví dụ**:
  ```
  # set interfaces dataplane dp0s3 vif 100 qos LIMIT_BANDWIDTH
  # set interfaces dataplane dp0s3 vif 100 firewall in WAN_IN
  # commit
  # save
  ```
  - Áp dụng chính sách QoS `LIMIT_BANDWIDTH` và tường lửa `WAN_IN` cho lưu lượng vào trên `dp0s3.100`.

### 4. Kiểm tra cấu hình giao diện VLAN
- **Mô tả**: Xem cấu hình hiện tại của giao diện VLAN.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show interfaces dataplane <interface> vif <vlan-id>
    ```
  - Trong chế độ vận hành:
    ```
    $ show interfaces
    $ show configuration commands | match vif
    ```
- **Ví dụ**:
  ```
  # show interfaces dataplane dp0s3 vif 100
  address 192.168.100.1/24
  qos LIMIT_BANDWIDTH
  firewall {
      in WAN_IN
  }
  ```

### 5. Kiểm tra trạng thái giao diện VLAN
- **Mô tả**: Hiển thị trạng thái hoạt động của giao diện VLAN, bao gồm lưu lượng, trạng thái liên kết, và thống kê.
- **Lệnh**:
  ```
  $ show interfaces dataplane <interface> vif <vlan-id>
  ```
- **Ví dụ**:
  ```
  $ show interfaces dataplane dp0s3 vif 100
  dp0s3.100: <BROADCAST,MULTICAST,UP> mtu 1500 qdisc pfifo_fast state UP
      inet 192.168.100.1/24 brd 192.168.100.255 scope global dp0s3.100
      RX: bytes  packets  errors  dropped
          120000  1500     0       0
      TX: bytes  packets  errors  dropped
          160000  2000     0       0
  ```
  - Hiển thị trạng thái, địa chỉ IP, và thống kê lưu lượng của `dp0s3.100`.

### 6. Xóa giao diện VLAN
- **Mô tả**: Xóa giao diện VLAN hoặc một cấu hình cụ thể của nó.
- **Lệnh**:
  ```
  # delete interfaces dataplane <interface> vif <vlan-id>
  # delete interfaces dataplane <interface> vif <vlan-id> address <ip-address/prefix>
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete interfaces dataplane dp0s3 vif 100 address 192.168.100.1/24
  # commit
  # save
  ```
  - Xóa địa chỉ IP khỏi `dp0s3.100`.
  ```
  # delete interfaces dataplane dp0s3 vif 100
  # commit
  # save
  ```
  - Xóa toàn bộ giao diện VLAN `dp0s3.100`.

### 7. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + interfaces dataplane dp0s3 vif 100 address 192.168.100.1/24
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit.

## Ví dụ thực tế: Cấu hình giao diện VLAN
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Tạo giao diện VLAN:
   ```
   # set interfaces dataplane dp0s3 vif 100
   # set interfaces dataplane dp0s3 vif 100 address 192.168.100.1/24
   ```
3. Áp dụng chính sách QoS:
   ```
   # set qos policy LIMIT_BANDWIDTH rule 10 match ALL
   # set qos policy LIMIT_BANDWIDTH rule 10 bandwidth 10mbit
   # set interfaces dataplane dp0s3 vif 100 qos LIMIT_BANDWIDTH
   ```
4. Kiểm tra cấu hình:
   ```
   # show interfaces dataplane dp0s3 vif 100
   address 192.168.100.1/24
   qos LIMIT_BANDWIDTH
   ```
5. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
6. Kiểm tra trạng thái:
   ```
   $ show interfaces dataplane dp0s3 vif 100
   dp0s3.100: <BROADCAST,MULTICAST,UP> mtu 1500 qdisc pfifo_fast state UP
      inet 192.168.100.1/24 brd 192.168.100.255 scope global dp0s3.100
      RX: bytes  packets  errors  dropped
          120000  1500     0       0
      TX: bytes  packets  errors  dropped
          160000  2000     0       0
   ```
   ```
   $ show qos policy LIMIT_BANDWIDTH statistics
   Rule    Packets    Bytes    Match    Bandwidth
   ----    -------    -----    ------   ---------
   10      1500       120000   ALL      10mbit
   ```

## Lưu ý quan trọng
- **VLAN ID hợp lệ**: Sử dụng VLAN ID từ 1 đến 4094. Đảm bảo VLAN ID khớp với cấu hình trên switch hoặc thiết bị mạng khác.
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi:
  ```
  $ save /config/backup-20250907.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi (ví dụ: giao diện không tồn tại, VLAN ID trùng lặp).
- **Hiệu suất**: Nhiều giao diện VLAN có thể tăng tải CPU. Theo dõi bằng:
  ```
  $ show system cpu
  ```
- **Tích hợp với switch**: Đảm bảo giao diện vật lý được cấu hình ở chế độ trunk trên switch để hỗ trợ nhiều VLAN.
- **Tài liệu tham khảo**: Xem thêm chi tiết trên trang tài liệu vRouterOS hoặc tại https://docs.fwcloud.co.

## Kết luận
Cấu hình giao diện VLAN trong vRouterOS cho phép tách biệt và quản lý lưu lượng mạng hiệu quả. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để tạo và quản lý giao diện VLAN. Thực hành các ví dụ trên để làm quen với quy trình cấu hình VLAN và tích hợp với QoS hoặc tường lửa.