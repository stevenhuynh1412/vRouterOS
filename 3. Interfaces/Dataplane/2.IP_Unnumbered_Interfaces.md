# Hướng dẫn cấu hình giao diện IP Unnumbered trong vRouterOS

## Giới thiệu

**Giao diện IP Unnumbered** trong **vRouterOS** là một kỹ thuật cho phép một giao diện mạng sử dụng địa chỉ IP của một giao diện khác (thường là giao diện loopback) thay vì gán một địa chỉ IP riêng. Điều này giúp tiết kiệm địa chỉ IP, đặc biệt trong các mạng điểm-điểm (point-to-point) hoặc khi triển khai các giao thức định tuyến động.

Tài liệu này hướng dẫn cách:
- Cấu hình giao diện IP Unnumbered trên giao diện dataplane.
- Liên kết giao diện IP Unnumbered với giao diện loopback.
- Kiểm tra và giám sát trạng thái giao diện IP Unnumbered.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về giao diện IP Unnumbered

- **IP Unnumbered**: Cho phép một giao diện (thường là dataplane) mượn địa chỉ IP từ một giao diện khác (thường là loopback) thay vì gán địa chỉ IP trực tiếp.
- **Ứng dụng**:
  - Tiết kiệm địa chỉ IP trong các mạng điểm-điểm.
  - Đơn giản hóa cấu hình trong các giao thức định tuyến như OSPF hoặc BGP.
  - Tăng tính ổn định vì địa chỉ loopback thường không phụ thuộc vào trạng thái giao diện vật lý.
- **Yêu cầu**: Giao diện loopback (`lo`) hoặc một giao diện khác phải được gán địa chỉ IP trước khi cấu hình IP Unnumbered.

## Các lệnh cấu hình giao diện IP Unnumbered

### 1. Cấu hình giao diện Loopback
- **Mô tả**: Gán địa chỉ IP cho giao diện loopback, làm nguồn địa chỉ cho giao diện IP Unnumbered.
- **Lệnh**:
  ```
  # set interfaces loopback lo address <ip-address/prefix>
  ```
- **Ví dụ**:
  ```
  $ configure
  # set interfaces loopback lo address 192.168.1.1/32
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Gán địa chỉ IP `192.168.1.1/32` cho giao diện loopback `lo`.

### 2. Cấu hình giao diện IP Unnumbered
- **Mô tả**: Cấu hình giao diện dataplane để sử dụng địa chỉ IP của giao diện loopback.
- **Lệnh**:
  ```
  # set interfaces dataplane <interface> ip unnumbered donor-interface lo
  ```
  - `<interface>`: Tên giao diện dataplane (ví dụ: `dp0s3`).
  - `donor-interface`: Giao diện cung cấp địa chỉ IP (thường là `lo`).
- **Ví dụ**:
  ```
  # set interfaces dataplane dp0s3 ip unnumbered donor-interface lo
  # commit
  # save
  ```
  - Cấu hình `dp0s3` để sử dụng địa chỉ IP của giao diện loopback `lo`.

### 3. Áp dụng chính sách QoS hoặc tường lửa
- **Mô tả**: Áp dụng chính sách QoS, tường lửa, hoặc DPI cho giao diện IP Unnumbered giống như giao diện thông thường.
- **Lệnh**:
  ```
  # set interfaces dataplane <interface> qos <policy-name>
  # set interfaces dataplane <interface> firewall <direction> <rule-set-name>
  ```
  - `<direction>`: Hướng tường lửa (`in`, `out`, `local`).
- **Ví dụ**:
  ```
  # set interfaces dataplane dp0s3 qos LIMIT_BANDWIDTH
  # set interfaces dataplane dp0s3 firewall in WAN_IN
  # commit
  # save
  ```
  - Áp dụng chính sách QoS `LIMIT_BANDWIDTH` và tường lửa `WAN_IN` cho `dp0s3`.

### 4. Kiểm tra cấu hình giao diện IP Unnumbered
- **Mô tả**: Xem cấu hình hiện tại của giao diện IP Unnumbered.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show interfaces dataplane <interface>
    ```
  - Trong chế độ vận hành:
    ```
    $ show interfaces
    $ show configuration commands | match unnumbered
    ```
- **Ví dụ**:
  ```
  # show interfaces dataplane dp0s3
  ip {
      unnumbered {
          donor-interface lo
      }
  }
  qos LIMIT_BANDWIDTH
  firewall {
      in WAN_IN
  }
  ```

### 5. Kiểm tra trạng thái giao diện IP Unnumbered
- **Mô tả**: Hiển thị trạng thái hoạt động của giao diện IP Unnumbered, bao gồm địa chỉ IP mượn, trạng thái liên kết, và thống kê lưu lượng.
- **Lệnh**:
  ```
  $ show interfaces dataplane <interface>
  ```
- **Ví dụ**:
  ```
  $ show interfaces dataplane dp0s3
  dp0s3: <BROADCAST,MULTICAST,UP> mtu 1500 qdisc pfifo_fast state UP
      inet 192.168.1.1/32 (unnumbered, donor: lo) scope global dp0s3
      RX: bytes  packets  errors  dropped
          120000  1500     0       0
      TX: bytes  packets  errors  dropped
          160000  2000     0       0
  ```
  - Hiển thị `dp0s3` sử dụng địa chỉ IP `192.168.1.1/32` mượn từ `lo`.

### 6. Xóa cấu hình IP Unnumbered
- **Mô tả**: Xóa cấu hình IP Unnumbered hoặc một phần của nó.
- **Lệnh**:
  ```
  # delete interfaces dataplane <interface> ip unnumbered
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete interfaces dataplane dp0s3 ip unnumbered
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Xóa cấu hình IP Unnumbered khỏi `dp0s3`.

### 7. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + interfaces dataplane dp0s3 ip unnumbered donor-interface lo
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit.

## Ví dụ thực tế: Cấu hình giao diện IP Unnumbered
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Cấu hình giao diện loopback:
   ```
   # set interfaces loopback lo address 192.168.1.1/32
   ```
3. Cấu hình giao diện IP Unnumbered:
   ```
   # set interfaces dataplane dp0s3 ip unnumbered donor-interface lo
   ```
4. Áp dụng chính sách QoS:
   ```
   # set qos policy LIMIT_BANDWIDTH rule 10 match ALL
   # set qos policy LIMIT_BANDWIDTH rule 10 bandwidth 10mbit
   # set interfaces dataplane dp0s3 qos LIMIT_BANDWIDTH
   ```
5. Kiểm tra cấu hình:
   ```
   # show interfaces dataplane dp0s3
   ip {
       unnumbered {
           donor-interface lo
       }
   }
   qos LIMIT_BANDWIDTH
   ```
6. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
7. Kiểm tra trạng thái:
   ```
   $ show interfaces dataplane dp0s3
   dp0s3: <BROADCAST,MULTICAST,UP> mtu 1500 qdisc pfifo_fast state UP
      inet 192.168.1.1/32 (unnumbered, donor: lo) scope global dp0s3
      RX: bytes  packets  errors  dropped
          120000  1500     0       0
      TX: bytes  packets  errors  dropped
          160000  2000     0       0
   ```
   ```
   $ show qos policy LIMIT_BANDWIDTH statistics
   Rule    Packets    Bytes    Match    Bandwidth
   ----    -------    -----    ------   ---------
   10      1500       120000   ALL      10mbit
   ```

## Lưu ý quan trọng
- **Giao diện Loopback**: Giao diện loopback (`lo`) phải có địa chỉ IP trước khi cấu hình IP Unnumbered.
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi:
  ```
  $ save /config/backup-20250907.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi (ví dụ: `donor-interface` không tồn tại hoặc chưa có địa chỉ IP).
- **Giao thức định tuyến**: IP Unnumbered thường được sử dụng với OSPF hoặc BGP. Đảm bảo cấu hình giao thức định tuyến phù hợp:
  ```
  # set protocols ospf interface dp0s3
  ```
- **Hiệu suất**: Theo dõi tải CPU khi sử dụng IP Unnumbered trong mạng lớn:
  ```
  $ show system cpu
  ```
- **Tài liệu tham khảo**: Xem thêm chi tiết trên trang tài liệu vRouterOS hoặc tại https://docs.fwcloud.co.

## Kết luận
Giao diện IP Unnumbered trong vRouterOS giúp tiết kiệm địa chỉ IP và đơn giản hóa cấu hình định tuyến. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để cấu hình và quản lý giao diện IP Unnumbered hiệu quả. Thực hành các ví dụ trên để làm quen với quy trình và tích hợp với các giao thức định tuyến hoặc chính sách QoS/tường lửa.