# Hướng dẫn cấu hình Prefix List Policy trong vRouterOS

## Giới thiệu

**Prefix List Policy** trong **vRouterOS** là một cơ chế dùng để lọc và kiểm soát các tiền tố IP (prefix) trong các giao thức định tuyến động như BGP, OSPF, hoặc RIP. Prefix List cho phép quản trị viên xác định các tiền tố IP được phép hoặc bị từ chối, giúp kiểm soát việc quảng bá hoặc chấp nhận các tuyến đường (routes) trong mạng.

Tài liệu này hướng dẫn cách:
- Tạo và cấu hình Prefix List với các quy tắc để lọc tiền tố IP.
- Áp dụng Prefix List vào giao thức định tuyến.
- Kiểm tra và giám sát cấu hình Prefix List.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về Prefix List Policy

- **Prefix List**: Một tập hợp các quy tắc (rules) xác định các tiền tố IP được phép (`permit`) hoặc bị từ chối (`deny`) dựa trên địa chỉ mạng và độ dài tiền tố (prefix length).
- **Ứng dụng**:
  - Lọc các tuyến đường trong BGP để kiểm soát quảng bá hoặc nhận tuyến.
  - Giới hạn các tuyến đường trong OSPF hoặc RIP để tăng cường bảo mật hoặc tối ưu hóa bảng định tuyến.
- **Tiêu chí lọc**:
  - **Exact match**: Khớp chính xác tiền tố và độ dài (ví dụ: `192.168.1.0/24`).
  - **Range match**: Khớp tiền tố với độ dài trong khoảng (ví dụ: `192.168.0.0/16 le 24` để khớp `/16` đến `/24`).
- **Ưu điểm**: Cung cấp khả năng kiểm soát chi tiết hơn Access List, đặc biệt trong các giao thức định tuyến.

## Các lệnh cấu hình Prefix List

### 1. Tạo Prefix List
- **Mô tả**: Tạo một Prefix List với các quy tắc để cho phép hoặc từ chối các tiền tố IP.
- **Lệnh**:
  ```
  # set policy prefix-list <list-name> rule <rule-number> action <permit|deny>
  # set policy prefix-list <list-name> rule <rule-number> prefix <ip-address/prefix>
  # set policy prefix-list <list-name> rule <rule-number> ge <value>
  # set policy prefix-list <list-name> rule <rule-number> le <value>
  ```
  - `<list-name>`: Tên của Prefix List (ví dụ: `BGP_FILTER`).
  - `<rule-number>`: Số thứ tự quy tắc (1-65535).
  - `<ip-address/prefix>`: Tiền tố IP (ví dụ: `192.168.1.0/24`).
  - `<ge>`: Độ dài tiền tố tối thiểu (greater than or equal).
  - `<le>`: Độ dài tiền tố tối đa (less than or equal).
- **Ví dụ**:
  ```
  $ configure
  # set policy prefix-list BGP_FILTER rule 10 action permit
  # set policy prefix-list BGP_FILTER rule 10 prefix 192.168.1.0/24
  # set policy prefix-list BGP_FILTER rule 20 action deny
  # set policy prefix-list BGP_FILTER rule 20 prefix 10.0.0.0/8
  # set policy prefix-list BGP_FILTER rule 20 le 24
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Tạo Prefix List `BGP_FILTER`:
    - Quy tắc 10: Cho phép tiền tố `192.168.1.0/24`.
    - Quy tắc 20: Từ chối tiền tố `10.0.0.0/8` với độ dài tối đa `/24`.

### 2. Áp dụng Prefix List vào giao thức định tuyến
- **Mô tả**: Gắn Prefix List vào giao thức định tuyến (như BGP) để lọc các tuyến đường.
- **Lệnh** (ví dụ với BGP):
  ```
  # set protocols bgp <asn> neighbor <neighbor-ip> prefix-list <import|export> <list-name>
  ```
  - `<asn>`: Số AS của BGP.
  - `<neighbor-ip>`: Địa chỉ IP của láng giềng BGP.
  - `<import|export>`: Lọc tuyến đường nhận vào (`import`) hoặc gửi đi (`export`).
- **Ví dụ**:
  ```
  # set protocols bgp 65001 neighbor 192.168.1.2 prefix-list import BGP_FILTER
  # commit
  # save
  ```
  - Áp dụng Prefix List `BGP_FILTER` để lọc các tuyến đường nhận từ láng giềng BGP `192.168.1.2`.

### 3. Kiểm tra cấu hình Prefix List
- **Mô tả**: Xem cấu hình Prefix List hiện tại.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show policy prefix-list
    ```
  - Trong chế độ vận hành:
    ```
    $ show configuration commands | match prefix-list
    ```
- **Ví dụ**:
  ```
  # show policy prefix-list
  prefix-list BGP_FILTER {
      rule 10 {
          action permit
          prefix 192.168.1.0/24
      }
      rule 20 {
          action deny
          prefix 10.0.0.0/8
          le 24
      }
  }
  ```

### 4. Kiểm tra trạng thái Prefix List
- **Mô tả**: Kiểm tra trạng thái áp dụng của Prefix List trong giao thức định tuyến.
- **Lệnh** (ví dụ với BGP):
  ```
  $ show ip bgp neighbors <neighbor-ip>
  ```
- **Ví dụ**:
  ```
  $ show ip bgp neighbors 192.168.1.2
  BGP neighbor is 192.168.1.2, remote AS 65002
  Prefix-list: import BGP_FILTER
  ```
  - Xác nhận Prefix List `BGP_FILTER` được áp dụng cho láng giềng BGP.

### 5. Xóa Prefix List
- **Mô tả**: Xóa Prefix List hoặc một quy tắc cụ thể.
- **Lệnh**:
  ```
  # delete policy prefix-list <list-name> rule <rule-number>
  # delete policy prefix-list <list-name>
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete policy prefix-list BGP_FILTER rule 10
  # commit
  # save
  ```
  - Xóa quy tắc 10 trong Prefix List `BGP_FILTER`.
  ```
  # delete policy prefix-list BGP_FILTER
  # commit
  # save
  ```
  - Xóa toàn bộ Prefix List `BGP_FILTER`.

### 6. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + policy prefix-list BGP_FILTER rule 10 action permit
    + policy prefix-list BGP_FILTER rule 10 prefix 192.168.1.0/24
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit.

## Ví dụ thực tế: Cấu hình Prefix List cho BGP
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Tạo Prefix List:
   ```
   # set policy prefix-list BGP_FILTER rule 10 action permit
   # set policy prefix-list BGP_FILTER rule 10 prefix 192.168.1.0/24
   # set policy prefix-list BGP_FILTER rule 20 action deny
   # set policy prefix-list BGP_FILTER rule 20 prefix 10.0.0.0/8
   # set policy prefix-list BGP_FILTER rule 20 le 24
   ```
3. Áp dụng Prefix List vào BGP:
   ```
   # set protocols bgp 65001 neighbor 192.168.1.2 prefix-list import BGP_FILTER
   ```
4. Kiểm tra cấu hình:
   ```
   # show policy prefix-list
   prefix-list BGP_FILTER {
       rule 10 {
           action permit
           prefix 192.168.1.0/24
       }
       rule 20 {
           action deny
           prefix 10.0.0.0/8
           le 24
       }
   }
   ```
5. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
6. Kiểm tra trạng thái:
   ```
   $ show ip bgp neighbors 192.168.1.2
   BGP neighbor is 192.168.1.2, remote AS 65002
   Prefix-list: import BGP_FILTER
   ```

## Lưu ý quan trọng
- **Thứ tự quy tắc**: Quy tắc được xử lý theo số thứ tự (`rule-number`). Quy tắc có số nhỏ hơn được ưu tiên.
- **Hành động mặc định**: Nếu không có quy tắc nào khớp, tiền tố được phép (`permit`) trừ khi có quy tắc `deny` cuối cùng.
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi:
  ```
  $ save /config/backup-20250908.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi (ví dụ: tiền tố không hợp lệ, giao thức định tuyến không được cấu hình).
- **Tích hợp với giao thức định tuyến**: Đảm bảo giao thức định tuyến (như BGP) đã được cấu hình trước khi áp dụng Prefix List.

## Kết luận
Prefix List Policy trong vRouterOS cung cấp một phương pháp mạnh mẽ để kiểm soát các tiền tố IP trong các giao thức định tuyến. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để cấu hình và quản lý Prefix List hiệu quả. Thực hành các ví dụ trên để làm quen với quy trình và đảm bảo kiểm soát tuyến đường mạng một cách chính xác.