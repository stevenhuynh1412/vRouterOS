# Hướng dẫn cấu hình Route Map Policy trong vRouterOS

## Giới thiệu

**Route Map Policy** trong **vRouterOS** là một công cụ mạnh mẽ để kiểm soát và thao tác các tuyến đường (routes) trong các giao thức định tuyến động như BGP, OSPF, hoặc RIP. Route Map cho phép quản trị viên lọc, sửa đổi thuộc tính tuyến đường (như metric, preference, hoặc community), hoặc áp dụng các chính sách định tuyến phức tạp dựa trên nhiều tiêu chí.

Tài liệu này hướng dẫn cách:
- Tạo và cấu hình Route Map với các quy tắc (rules).
- Áp dụng Route Map vào giao thức định tuyến.
- Kiểm tra và giám sát cấu hình Route Map.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về Route Map Policy

- **Route Map**: Một tập hợp các quy tắc (rules) được đánh số, xác định cách xử lý tuyến đường dựa trên các tiêu chí khớp (match) và hành động (action).
- **Tiêu chí khớp (Match)**:
  - Dựa trên tiền tố IP (prefix), sử dụng Prefix List.
  - Dựa trên thuộc tính tuyến đường như AS path, community, hoặc metric.
- **Hành động (Action)**:
  - `permit`: Cho phép tuyến đường và tiếp tục xử lý.
  - `deny`: Từ chối tuyến đường.
  - `set`: Sửa đổi thuộc tính tuyến đường (ví dụ: metric, community).
- **Ứng dụng**:
  - Lọc tuyến đường trong BGP để kiểm soát quảng bá hoặc nhận tuyến.
  - Sửa đổi thuộc tính tuyến đường để ưu tiên hoặc điều chỉnh định tuyến.
- **Ưu điểm**: Linh hoạt hơn Prefix List, cho phép kết hợp nhiều tiêu chí và hành động phức tạp.

## Các lệnh cấu hình Route Map

### 1. Tạo Route Map
- **Mô tả**: Tạo một Route Map với các quy tắc để lọc hoặc sửa đổi tuyến đường.
- **Lệnh**:
  ```
  # set policy route-map <map-name> rule <rule-number> action <permit|deny>
  # set policy route-map <map-name> rule <rule-number> match ip address prefix-list <list-name>
  # set policy route-map <map-name> rule <rule-number> set <attribute> <value>
  ```
  - `<map-name>`: Tên của Route Map (ví dụ: `BGP_CONTROL`).
  - `<rule-number>`: Số thứ tự quy tắc (1-65535).
  - `<list-name>`: Tên Prefix List để khớp tiền tố IP.
  - `<attribute>`: Thuộc tính tuyến đường (ví dụ: `metric`, `community`, `local-preference`).
- **Ví dụ**:
  ```
  $ configure
  # set policy route-map BGP_CONTROL rule 10 action permit
  # set policy route-map BGP_CONTROL rule 10 match ip address prefix-list BGP_FILTER
  # set policy route-map BGP_CONTROL rule 10 set metric 100
  # set policy route-map BGP_CONTROL rule 20 action deny
  # set policy route-map BGP_CONTROL rule 20 match ip address prefix-list DENY_LIST
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Tạo Route Map `BGP_CONTROL`:
    - Quy tắc 10: Cho phép tuyến đường khớp với Prefix List `BGP_FILTER` và đặt metric là 100.
    - Quy tắc 20: Từ chối tuyến đường khớp với Prefix List `DENY_LIST`.

### 2. Áp dụng Route Map vào giao thức định tuyến
- **Mô tả**: Gắn Route Map vào giao thức định tuyến (như BGP) để lọc hoặc sửa đổi tuyến đường.
- **Lệnh** (ví dụ với BGP):
  ```
  # set protocols bgp <asn> neighbor <neighbor-ip> route-map <import|export> <map-name>
  ```
  - `<asn>`: Số AS của BGP.
  - `<neighbor-ip>`: Địa chỉ IP của láng giềng BGP.
  - `<import|export>`: Áp dụng Route Map cho tuyến đường nhận vào (`import`) hoặc gửi đi (`export`).
- **Ví dụ**:
  ```
  # set protocols bgp 65001 neighbor 192.168.1.2 route-map import BGP_CONTROL
  # commit
  # save
  ```
  - Áp dụng Route Map `BGP_CONTROL` để lọc các tuyến đường nhận từ láng giềng BGP `192.168.1.2`.

### 3. Kiểm tra cấu hình Route Map
- **Mô tả**: Xem cấu hình Route Map hiện tại.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show policy route-map
    ```
  - Trong chế độ vận hành:
    ```
    $ show configuration commands | match route-map
    ```
- **Ví dụ**:
  ```
  # show policy route-map
  route-map BGP_CONTROL {
      rule 10 {
          action permit
          match {
              ip {
                  address {
                      prefix-list BGP_FILTER
                  }
              }
          }
          set {
              metric 100
          }
      }
      rule 20 {
          action deny
          match {
              ip {
                  address {
                      prefix-list DENY_LIST
                  }
              }
          }
      }
  }
  ```

### 4. Kiểm tra trạng thái Route Map
- **Mô tả**: Kiểm tra trạng thái áp dụng của Route Map trong giao thức định tuyến.
- **Lệnh** (ví dụ với BGP):
  ```
  $ show ip bgp neighbors <neighbor-ip>
  ```
- **Ví dụ**:
  ```
  $ show ip bgp neighbors 192.168.1.2
  BGP neighbor is 192.168.1.2, remote AS 65002
  Route-map: import BGP_CONTROL
  ```
  - Xác nhận Route Map `BGP_CONTROL` được áp dụng cho láng giềng BGP.

### 5. Xóa Route Map
- **Mô tả**: Xóa Route Map hoặc một quy tắc cụ thể.
- **Lệnh**:
  ```
  # delete policy route-map <map-name> rule <rule-number>
  # delete policy route-map <map-name>
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete policy route-map BGP_CONTROL rule 10
  # commit
  # save
  ```
  - Xóa quy tắc 10 trong Route Map `BGP_CONTROL`.
  ```
  # delete policy route-map BGP_CONTROL
  # commit
  # save
  ```
  - Xóa toàn bộ Route Map `BGP_CONTROL`.

### 6. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + policy route-map BGP_CONTROL rule 10 action permit
    + policy route-map BGP_CONTROL rule 10 match ip address prefix-list BGP_FILTER
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit.

## Ví dụ thực tế: Cấu hình Route Map cho BGP
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Tạo Prefix List để sử dụng trong Route Map:
   ```
   # set policy prefix-list BGP_FILTER rule 10 action permit
   # set policy prefix-list BGP_FILTER rule 10 prefix 192.168.1.0/24
   # set policy prefix-list DENY_LIST rule 10 action permit
   # set policy prefix-list DENY_LIST rule 10 prefix 10.0.0.0/8
   ```
3. Tạo Route Map:
   ```
   # set policy route-map BGP_CONTROL rule 10 action permit
   # set policy route-map BGP_CONTROL rule 10 match ip address prefix-list BGP_FILTER
   # set policy route-map BGP_CONTROL rule 10 set metric 100
   # set policy route-map BGP_CONTROL rule 20 action deny
   # set policy route-map BGP_CONTROL rule 20 match ip address prefix-list DENY_LIST
   ```
4. Áp dụng Route Map vào BGP:
   ```
   # set protocols bgp 65001 neighbor 192.168.1.2 route-map import BGP_CONTROL
   ```
5. Kiểm tra cấu hình:
   ```
   # show policy route-map
   route-map BGP_CONTROL {
       rule 10 {
           action permit
           match {
               ip {
                   address {
                       prefix-list BGP_FILTER
                   }
               }
           }
           set {
               metric 100
           }
       }
       rule 20 {
           action deny
           match {
               ip {
                   address {
                       prefix-list DENY_LIST
                   }
               }
           }
       }
   }
   ```
6. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
7. Kiểm tra trạng thái:
   ```
   $ show ip bgp neighbors 192.168.1.2
   BGP neighbor is 192.168.1.2, remote AS 65002
   Route-map: import BGP_CONTROL
   ```

## Lưu ý quan trọng
- **Thứ tự quy tắc**: Quy tắc được xử lý theo số thứ tự (`rule-number`). Quy tắc có số nhỏ hơn được ưu tiên.
- **Hành động mặc định**: Nếu không có quy tắc nào khớp, tuyến đường được phép (`permit`) trừ khi có quy tắc `deny` cuối cùng.
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi:
  ```
  $ save /config/backup-20250908.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi (ví dụ: Prefix List không tồn tại, thuộc tính không hợp lệ).
- **Tích hợp với Prefix List**: Đảm bảo Prefix List được cấu hình trước khi sử dụng trong Route Map.
- **Tài nguyên hệ thống**: Route Map phức tạp có thể tăng tải CPU. Theo dõi bằng:
  ```
  $ show system cpu
  ```

## Kết luận
Route Map Policy trong vRouterOS cung cấp khả năng kiểm soát linh hoạt các tuyến đường trong giao thức định tuyến. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để cấu hình và quản lý Route Map hiệu quả. Thực hành các ví dụ trên để làm quen với quy trình và đảm bảo kiểm soát định tuyến chính xác.