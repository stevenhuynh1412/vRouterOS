# Hướng dẫn cấu hình AS Path Policy trong vRouterOS

## Giới thiệu

**AS Path Policy** trong **vRouterOS** là một cơ chế dùng để lọc các tuyến đường BGP dựa trên danh sách đường dẫn AS (Autonomous System Path). AS Path List cho phép quản trị viên xác định các tuyến đường được phép hoặc bị từ chối dựa trên các mẫu (pattern) của số AS trong đường dẫn, giúp kiểm soát việc quảng bá hoặc chấp nhận các tuyến đường trong giao thức BGP.

Tài liệu này hướng dẫn cách:
- Tạo và cấu hình AS Path List với các quy tắc để lọc đường dẫn AS.
- Áp dụng AS Path List vào giao thức BGP.
- Kiểm tra và giám sát cấu hình AS Path List.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về AS Path Policy

- **AS Path List**: Một tập hợp các quy tắc (rules) xác định các mẫu đường dẫn AS được phép (`permit`) hoặc bị từ chối (`deny`) sử dụng biểu thức chính quy (regular expression).
- **Ứng dụng**:
  - Lọc các tuyến đường BGP để chỉ chấp nhận hoặc quảng bá các tuyến từ các AS cụ thể.
  - Ngăn chặn các tuyến đường từ các AS không mong muốn (ví dụ: AS của đối thủ hoặc AS không hợp lệ).
  - Tối ưu hóa bảng định tuyến BGP bằng cách loại bỏ các tuyến đường không cần thiết.
- **Biểu thức chính quy (Regular Expression)**:
  - `_`: Khớp khoảng trắng giữa các số AS.
  - `^`: Khớp bắt đầu đường dẫn AS.
  - `$`: Khớp kết thúc đường dẫn AS.
  - `.*`: Khớp bất kỳ chuỗi AS nào.
  - Ví dụ: `^100_200$` khớp với đường dẫn AS bắt đầu bằng AS 100 và kết thúc bằng AS 200.

## Các lệnh cấu hình AS Path List

### 1. Tạo AS Path List
- **Mô tả**: Tạo một AS Path List với các quy tắc để cho phép hoặc từ chối các đường dẫn AS.
- **Lệnh**:
  ```
  # set policy as-path-list <list-name> rule <rule-number> action <permit|deny>
  # set policy as-path-list <list-name> rule <rule-number> regex <expression>
  ```
  - `<list-name>`: Tên của AS Path List (ví dụ: `BGP_AS_FILTER`).
  - `<rule-number>`: Số thứ tự quy tắc (1-65535).
  - `<expression>`: Biểu thức chính quy để khớp đường dẫn AS.
- **Ví dụ**:
  ```
  $ configure
  # set policy as-path-list BGP_AS_FILTER rule 10 action permit
  # set policy as-path-list BGP_AS_FILTER rule 10 regex "^100_200$"
  # set policy as-path-list BGP_AS_FILTER rule 20 action deny
  # set policy as-path-list BGP_AS_FILTER rule 20 regex ".*300.*"
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Tạo AS Path List `BGP_AS_FILTER`:
    - Quy tắc 10: Cho phép tuyến đường với đường dẫn AS chính xác là `100 200`.
    - Quy tắc 20: Từ chối tuyến đường chứa AS 300 ở bất kỳ vị trí nào.

### 2. Áp dụng AS Path List vào giao thức BGP
- **Mô tả**: Gắn AS Path List vào giao thức BGP để lọc các tuyến đường.
- **Lệnh**:
  ```
  # set protocols bgp <asn> neighbor <neighbor-ip> as-path-list <import|export> <list-name>
  ```
  - `<asn>`: Số AS của BGP.
  - `<neighbor-ip>`: Địa chỉ IP của láng giềng BGP.
  - `<import|export>`: Lọc tuyến đường nhận vào (`import`) hoặc gửi đi (`export`).
- **Ví dụ**:
  ```
  # set protocols bgp 65001 neighbor 192.168.1.2 as-path-list import BGP_AS_FILTER
  # commit
  # save
  ```
  - Áp dụng AS Path List `BGP_AS_FILTER` để lọc các tuyến đường nhận từ láng giềng BGP `192.168.1.2`.

### 3. Kiểm tra cấu hình AS Path List
- **Mô tả**: Xem cấu hình AS Path List hiện tại.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show policy as-path-list
    ```
  - Trong chế độ vận hành:
    ```
    $ show configuration commands | match as-path-list
    ```
- **Ví dụ**:
  ```
  # show policy as-path-list
  as-path-list BGP_AS_FILTER {
      rule 10 {
          action permit
          regex "^100_200$"
      }
      rule 20 {
          action deny
          regex ".*300.*"
      }
  }
  ```

### 4. Kiểm tra trạng thái AS Path List
- **Mô tả**: Kiểm tra trạng thái áp dụng của AS Path List trong giao thức BGP.
- **Lệnh**:
  ```
  $ show ip bgp neighbors <neighbor-ip>
  ```
- **Ví dụ**:
  ```
  $ show ip bgp neighbors 192.168.1.2
  BGP neighbor is 192.168.1.2, remote AS 65002
  AS Path List: import BGP_AS_FILTER
  ```
  - Xác nhận AS Path List `BGP_AS_FILTER` được áp dụng cho láng giềng BGP.

### 5. Xóa AS Path List
- **Mô tả**: Xóa AS Path List hoặc một quy tắc cụ thể.
- **Lệnh**:
  ```
  # delete policy as-path-list <list-name> rule <rule-number>
  # delete policy as-path-list <list-name>
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete policy as-path-list BGP_AS_FILTER rule 10
  # commit
  # save
  ```
  - Xóa quy tắc 10 trong AS Path List `BGP_AS_FILTER`.
  ```
  # delete policy as-path-list BGP_AS_FILTER
  # commit
  # save
  ```
  - Xóa toàn bộ AS Path List `BGP_AS_FILTER`.

### 6. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + policy as-path-list BGP_AS_FILTER rule 10 action permit
    + policy as-path-list BGP_AS_FILTER rule 10 regex "^100_200$"
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit.

## Ví dụ thực tế: Cấu hình AS Path List cho BGP
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Tạo AS Path List:
   ```
   # set policy as-path-list BGP_AS_FILTER rule 10 action permit
   # set policy as-path-list BGP_AS_FILTER rule 10 regex "^100_200$"
   # set policy as-path-list BGP_AS_FILTER rule 20 action deny
   # set policy as-path-list BGP_AS_FILTER rule 20 regex ".*300.*"
   ```
3. Áp dụng AS Path List vào BGP:
   ```
   # set protocols bgp 65001 neighbor 192.168.1.2 as-path-list import BGP_AS_FILTER
   ```
4. Kiểm tra cấu hình:
   ```
   # show policy as-path-list
   as-path-list BGP_AS_FILTER {
       rule 10 {
           action permit
           regex "^100_200$"
       }
       rule 20 {
           action deny
           regex ".*300.*"
       }
   }
   ```
5. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
6. Kiểm tra trạng thái:
   ```
   $ show ip bgp neighbors 192.168.1.2
   BGP neighbor is 192.168.1.2, remote AS 65002
   AS Path List: import BGP_AS_FILTER
   ```

## Lưu ý quan trọng
- **Thứ tự quy tắc**: Quy tắc được xử lý theo số thứ tự (`rule-number`). Quy tắc có số nhỏ hơn được ưu tiên.
- **Hành động mặc định**: Nếu không có quy tắc nào khớp, tuyến đường được phép (`permit`) trừ khi có quy tắc `deny` cuối cùng.
- **Biểu thức chính quy**: Đảm bảo biểu thức chính quy được viết đúng để tránh lỗi lọc. Sử dụng các công cụ như `regex101.com` để kiểm tra.
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi:
  ```
  $ save /config/backup-20250908.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi (ví dụ: biểu thức chính quy không hợp lệ, BGP không được cấu hình).
- **Tích hợp với BGP**: Đảm bảo giao thức BGP đã được cấu hình trước khi áp dụng AS Path List.
- **Tài nguyên hệ thống**: AS Path List phức tạp có thể tăng tải CPU. Theo dõi bằng:
  ```
  $ show system cpu
  ```

## Kết luận
AS Path Policy trong vRouterOS cung cấp khả năng kiểm soát chi tiết các tuyến đường BGP dựa trên đường dẫn AS. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để cấu hình và quản lý AS Path List hiệu quả. Thực hành các ví dụ trên để làm quen với quy trình và đảm bảo kiểm soát tuyến đường BGP một cách chính xác.