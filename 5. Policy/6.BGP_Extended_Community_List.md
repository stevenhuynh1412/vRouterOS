# Hướng dẫn cấu hình Extended Community List Policy trong vRouterOS

## Giới thiệu

**Extended Community List Policy** trong **vRouterOS** là một cơ chế dùng để lọc và thao tác các tuyến đường BGP dựa trên thuộc tính cộng đồng mở rộng (extended community attribute). Extended Community List cho phép quản trị viên xác định các tuyến đường được phép hoặc bị từ chối dựa trên các giá trị cộng đồng mở rộng, đồng thời hỗ trợ sửa đổi thuộc tính này để điều khiển chính sách định tuyến, đặc biệt trong các kịch bản như VPN hoặc MPLS.

Tài liệu này hướng dẫn cách:
- Tạo và cấu hình Extended Community List với các quy tắc để lọc hoặc sửa đổi cộng đồng mở rộng.
- Áp dụng Extended Community List vào giao thức BGP thông qua Route Map.
- Kiểm tra và giám sát cấu hình Extended Community List.

Các lệnh được thực thi trong **chế độ vận hành** (ký hiệu `$`) hoặc **chế độ cấu hình** (ký hiệu `#`). Các thay đổi cần được **commit** để có hiệu lực và **lưu** để duy trì sau khi khởi động lại.

## Tổng quan về Extended Community List Policy

- **Extended Community List**: Một tập hợp các quy tắc (rules) xác định các giá trị cộng đồng mở rộng BGP được phép (`permit`) hoặc bị từ chối (`deny`) sử dụng biểu thức chính quy (regular expression) hoặc giá trị cụ thể.
- **Thuộc tính Extended Community trong BGP**:
  - Là một nhãn (tag) mở rộng (64-bit) so với cộng đồng chuẩn (32-bit), thường được sử dụng trong MPLS, VPN, hoặc các kịch bản định tuyến phức tạp.
  - Ví dụ: `rt:65001:100` (Route Target) hoặc `soo:65001:200` (Site of Origin).
- **Ứng dụng**:
  - Lọc tuyến đường BGP trong các môi trường VPN/MPLS.
  - Sửa đổi thuộc tính cộng đồng mở rộng để điều chỉnh chính sách định tuyến.
  - Kiểm soát việc nhập/xuất tuyến đường trong VRF (Virtual Routing and Forwarding).
- **Biểu thức chính quy (Regular Expression)**:
  - `.*`: Khớp bất kỳ chuỗi cộng đồng mở rộng.
  - `rt:65001:.*`: Khớp cộng đồng mở rộng Route Target bắt đầu bằng AS 65001.
  - `soo:[0-9]+:[0-9]+`: Khớp định dạng Site of Origin.

## Các lệnh cấu hình Extended Community List

### 1. Tạo Extended Community List
- **Mô tả**: Tạo một Extended Community List với các quy tắc để cho phép hoặc từ chối các giá trị cộng đồng mở rộng.
- **Lệnh**:
  ```
  # set policy extcommunity-list <list-name> rule <rule-number> action <permit|deny>
  # set policy extcommunity-list <list-name> rule <rule-number> regex <expression>
  ```
  - `<list-name>`: Tên của Extended Community List (ví dụ: `BGP_EXTCOMMUNITY_FILTER`).
  - `<rule-number>`: Số thứ tự quy tắc (1-65535).
  - `<expression>`: Biểu thức chính quy hoặc giá trị cộng đồng mở rộng cụ thể (ví dụ: `rt:65001:100`).
- **Ví dụ**:
  ```
  $ configure
  # set policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 10 action permit
  # set policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 10 regex "rt:65001:100"
  # set policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 20 action deny
  # set policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 20 regex "soo:.*:200"
  # commit
  # save
  Saving configuration to '/config/config.boot'...
  Done
  ```
  - Tạo Extended Community List `BGP_EXTCOMMUNITY_FILTER`:
    - Quy tắc 10: Cho phép tuyến đường với cộng đồng mở rộng `rt:65001:100`.
    - Quy tắc 20: Từ chối tuyến đường với cộng đồng mở rộng Site of Origin có giá trị kết thúc bằng `200`.

### 2. Áp dụng Extended Community List vào Route Map
- **Mô tả**: Sử dụng Extended Community List trong Route Map để lọc hoặc sửa đổi tuyến đường BGP.
- **Lệnh**:
  ```
  # set policy route-map <map-name> rule <rule-number> match extcommunity extcommunity-list <list-name>
  # set policy route-map <map-name> rule <rule-number> action <permit|deny>
  # set policy route-map <map-name> rule <rule-number> set extcommunity <extcommunity-value>
  ```
- **Ví dụ**:
  ```
  # set policy route-map BGP_CONTROL rule 10 match extcommunity extcommunity-list BGP_EXTCOMMUNITY_FILTER
  # set policy route-map BGP_CONTROL rule 10 action permit
  # set policy route-map BGP_CONTROL rule 10 set extcommunity "rt:65001:200"
  # set policy route-map BGP_CONTROL rule 20 action deny
  # commit
  # save
  ```
  - Tạo Route Map `BGP_CONTROL`:
    - Quy tắc 10: Cho phép tuyến đường khớp với Extended Community List `BGP_EXTCOMMUNITY_FILTER` và đặt cộng đồng mở rộng mới là `rt:65001:200`.
    - Quy tắc 20: Từ chối các tuyến đường còn lại.

### 3. Áp dụng Route Map vào BGP
- **Mô tả**: Gắn Route Map vào giao thức BGP để áp dụng chính sách lọc hoặc sửa đổi.
- **Lệnh**:
  ```
  # set protocols bgp <asn> neighbor <neighbor-ip> route-map <import|export> <map-name>
  ```
  - `<asn>`: Số AS của BGP.
  - `<neighbor-ip>`: Địa chỉ IP của láng giềng BGP.
  - `<import|export>`: Áp dụng Route Map cho tuyến đường nhận vào (`import`) hoặc gửi đi (`export`).
- **Ví dụ**:
  ```
  # set protocols bgp 65001 neighbor 192.168.1.2 route-map import BGP_CONTROL
  # commit
  # save
  ```
  - Áp dụng Route Map `BGP_CONTROL` để lọc các tuyến đường nhận từ láng giềng BGP `192.168.1.2`.

### 4. Kiểm tra cấu hình Extended Community List
- **Mô tả**: Xem cấu hình Extended Community List hiện tại.
- **Lệnh**:
  - Trong chế độ cấu hình:
    ```
    # show policy extcommunity-list
    ```
  - Trong chế độ vận hành:
    ```
    $ show configuration commands | match extcommunity-list
    ```
- **Ví dụ**:
  ```
  # show policy extcommunity-list
  extcommunity-list BGP_EXTCOMMUNITY_FILTER {
      rule 10 {
          action permit
          regex "rt:65001:100"
      }
      rule 20 {
          action deny
          regex "soo:.*:200"
      }
  }
  ```

### 5. Kiểm tra trạng thái Extended Community List
- **Mô tả**: Kiểm tra trạng thái áp dụng của Extended Community List trong giao thức BGP thông qua Route Map.
- **Lệnh**:
  ```
  $ show ip bgp neighbors <neighbor-ip>
  ```
- **Ví dụ**:
  ```
  $ show ip bgp neighbors 192.168.1.2
  BGP neighbor is 192.168.1.2, remote AS 65002
  Route-map: import BGP_CONTROL
  ```
  - Xác nhận Route Map `BGP_CONTROL` (liên kết với Extended Community List) được áp dụng cho láng giềng BGP.

### 6. Xóa Extended Community List
- **Mô tả**: Xóa Extended Community List hoặc một quy tắc cụ thể.
- **Lệnh**:
  ```
  # delete policy extcommunity-list <list-name> rule <rule-number>
  # delete policy extcommunity-list <list-name>
  ```
- **Ví dụ**:
  ```
  $ configure
  # delete policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 10
  # commit
  # save
  ```
  - Xóa quy tắc 10 trong Extended Community List `BGP_EXTCOMMUNITY_FILTER`.
  ```
  # delete policy extcommunity-list BGP_EXTCOMMUNITY_FILTER
  # commit
  # save
  ```
  - Xóa toàn bộ Extended Community List `BGP_EXTCOMMUNITY_FILTER`.

### 7. So sánh và hủy bỏ thay đổi
- **So sánh cấu hình**:
  ```
  # compare
  ```
  - Hiển thị sự khác biệt giữa cấu hình làm việc và cấu hình đang chạy.
  - Ví dụ:
    ```
    # compare
    + policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 10 action permit
    + policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 10 regex "rt:65001:100"
    ```
- **Hủy bỏ thay đổi**:
  ```
  # discard
  ```
  - Hủy các thay đổi chưa commit.

## Ví dụ thực tế: Cấu hình Extended Community List cho BGP
1. Vào chế độ cấu hình:
   ```
   $ configure
   ```
2. Tạo Extended Community List:
   ```
   # set policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 10 action permit
   # set policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 10 regex "rt:65001:100"
   # set policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 20 action deny
   # set policy extcommunity-list BGP_EXTCOMMUNITY_FILTER rule 20 regex "soo:.*:200"
   ```
3. Tạo Route Map sử dụng Extended Community List:
   ```
   # set policy route-map BGP_CONTROL rule 10 match extcommunity extcommunity-list BGP_EXTCOMMUNITY_FILTER
   # set policy route-map BGP_CONTROL rule 10 action permit
   # set policy route-map BGP_CONTROL rule 10 set extcommunity "rt:65001:200"
   # set policy route-map BGP_CONTROL rule 20 action deny
   ```
4. Áp dụng Route Map vào BGP:
   ```
   # set protocols bgp 65001 neighbor 192.168.1.2 route-map import BGP_CONTROL
   ```
5. Kiểm tra cấu hình:
   ```
   # show policy extcommunity-list
   extcommunity-list BGP_EXTCOMMUNITY_FILTER {
       rule 10 {
           action permit
           regex "rt:65001:100"
       }
       rule 20 {
           action deny
           regex "soo:.*:200"
       }
   }
   ```
6. Áp dụng và lưu:
   ```
   # commit
   # save
   Saving configuration to '/config/config.boot'...
   Done
   # exit
   ```
7. Kiểm tra trạng thái:
   ```
   $ show ip bgp neighbors 192.168.1.2
   BGP neighbor is 192.168.1.2, remote AS 65002
   Route-map: import BGP_CONTROL
   ```

## Lưu ý quan trọng
- **Thứ tự quy tắc**: Quy tắc được xử lý theo số thứ tự (`rule-number`). Quy tắc có số nhỏ hơn được ưu tiên.
- **Hành động mặc định**: Nếu không có quy tắc nào khớp, tuyến đường được phép (`permit`) trừ khi có quy tắc `deny` cuối cùng.
- **Biểu thức chính quy**: Đảm bảo biểu thức chính quy được viết đúng để tránh lỗi lọc. Sử dụng các công cụ như `regex101.com` để kiểm tra.
- **Sao lưu cấu hình**: Luôn sao lưu trước khi thay đổi:
  ```
  $ save /config/backup-20250908.conf
  ```
- **Kiểm tra lỗi**: Nếu `commit` thất bại, đọc thông báo lỗi (ví dụ: biểu thức chính quy không hợp lệ, Route Map không tồn tại).
- **Tích hợp với Route Map**: Extended Community List thường được sử dụng trong Route Map. Đảm bảo Route Map được cấu hình và áp dụng đúng.
- **Tài nguyên hệ thống**: Extended Community List phức tạp có thể tăng tải CPU. Theo dõi bằng:
  ```
  $ show system cpu
  ```

## Kết luận
Extended Community List Policy trong vRouterOS cung cấp khả năng kiểm soát chi tiết các tuyến đường BGP trong các môi trường phức tạp như VPN hoặc MPLS. Sử dụng các lệnh `set`, `delete`, `commit`, `show`, và `save` để cấu hình và quản lý Extended Community List hiệu quả. Thực hành các ví dụ trên để làm quen với quy trình và đảm bảo kiểm soát tuyến đường BGP một cách chính xác.